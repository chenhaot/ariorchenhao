<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Archive - Ari or Chenhao?</title>
  <link rel="stylesheet" href="css/style.css">
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QD5VPF7ZFK"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-QD5VPF7ZFK');
  </script>
</head>
<body>
  <nav>
    <span class="site-name">AI Hot Takes</span>
    <div class="nav-links">
      <a href="index.html">Play</a>
      <a href="archive.html" class="active">Archive</a>
      <a href="submit.html">Submit</a>
      <a href="about.html">About</a>
    </div>
  </nav>

  <div class="container">
    <h1>Archive</h1>

    <div class="loading" id="loading">Loading archive...</div>

    <div id="archive-content" class="hidden"></div>

    <div id="no-archive" class="hidden">
      <div class="hot-take-card" style="text-align: center;">
        <p>No archived hot takes yet. Check back after the first week!</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from './js/firebase-config.js';
    import { collection, query, where, getDocs, orderBy, getCountFromServer } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatWeekDate(dateStr) {
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    async function getVoteStats(takeId) {
      try {
        const agreeQuery = query(
          collection(db, "votes"),
          where("hottakeId", "==", takeId),
          where("opinion", "==", "agree")
        );
        const disagreeQuery = query(
          collection(db, "votes"),
          where("hottakeId", "==", takeId),
          where("opinion", "==", "disagree")
        );

        const [agreeSnap, disagreeSnap] = await Promise.all([
          getCountFromServer(agreeQuery),
          getCountFromServer(disagreeQuery)
        ]);

        const agree = agreeSnap.data().count;
        const disagree = disagreeSnap.data().count;
        const total = agree + disagree;

        if (total === 0) return null;

        return {
          agreePercent: Math.round((agree / total) * 100),
          disagreePercent: Math.round((disagree / total) * 100)
        };
      } catch (error) {
        console.error("Error fetching vote stats:", error);
        return null;
      }
    }

    async function loadArchive() {
      try {
        const q = query(
          collection(db, "hottakes"),
          where("approved", "==", true),
          orderBy("weekOf", "desc")
        );

        const snapshot = await getDocs(q);
        const takes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        document.getElementById('loading').classList.add('hidden');

        if (takes.length === 0) {
          document.getElementById('no-archive').classList.remove('hidden');
          return;
        }

        // Group by weekOf
        const grouped = {};
        takes.forEach(take => {
          const key = take.weekOf;
          if (!grouped[key]) {
            grouped[key] = { weekOf: take.weekOf, takes: [] };
          }
          grouped[key].takes.push(take);
        });

        const contentEl = document.getElementById('archive-content');
        contentEl.classList.remove('hidden');

        // Sort weeks descending
        const weeks = Object.values(grouped).sort((a, b) => b.weekOf.localeCompare(a.weekOf));

        const allTakes = [];
        weeks.forEach(weekData => {
          const weekEl = document.createElement('div');
          weekEl.className = 'archive-week';

          weekEl.innerHTML = `
            <h3>Week of ${formatWeekDate(weekData.weekOf)}</h3>
            ${weekData.takes.map(take => {
              allTakes.push(take);
              return `
              <div class="archive-item">
                <span class="author">${escapeHtml(take.author)}:</span> "${escapeHtml(take.text)}"
                <span class="vote-stats" id="vote-${take.id}"></span>
              </div>
            `;
            }).join('')}
          `;

          contentEl.appendChild(weekEl);
        });

        // Fetch vote stats for all takes
        allTakes.forEach(async (take) => {
          const stats = await getVoteStats(take.id);
          const el = document.getElementById(`vote-${take.id}`);
          if (el && stats) {
            el.textContent = ` (${stats.agreePercent}% agree, ${stats.disagreePercent}% disagree)`;
          }
        });

      } catch (error) {
        console.error("Error loading archive:", error);
        document.getElementById('loading').textContent = "Error loading archive. Please refresh.";
      }
    }

    loadArchive();
  </script>
</body>
</html>
